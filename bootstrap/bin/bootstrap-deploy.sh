#!/bin/bash
set -eo pipefail

SCRIPT_DIR="$(cd "$(dirname "${0}")"; pwd -P)"

export SOFTCOMWEB_INFRA_ACCOUNT_ID=250946034964
export SOFTCOMWEB_NONLIVE_ACCOUNT_ID=359150914216
export SOFTCOMWEB_LIVE_ACCOUNT_ID=593454847828

export CDK_CLI_VERSION="${CDK_CLI_VERSION:-1.93.0}"
export CDK_NEW_BOOTSTRAP=1
export CDK_BOOTSTRAP_TEMPLATE="${CDK_BOOTSTRAP_TEMPLATE:-${SCRIPT_DIR}/../lib/templates/cdk-bootstrap.yaml}"
export CDK_BOOTSTRAP_STACK="${CDK_BOOTSTRAP_STACK:-CDKToolkit}"
export CDK_BOOTSTRAP_QUALIFIER="${CDK_BOOTSTRAP_QUALIFIER}"
export CDK_BOOTSTRAP_ADDITIONAL_OPTS="${CDK_BOOTSTRAP_ADDITIONAL_OPTS}"

if [ ! -z "${CDK_BOOTSTRAP_QUALIFIER}" ]; then
  CDK_BOOTSTRAP_STACK="${CDK_BOOTSTRAP_STACK}-${CDK_BOOTSTRAP_QUALIFIER}"
  CDK_BOOTSTRAP_ADDITIONAL_OPTS="$CDK_BOOTSTRAP_ADDITIONAL_OPTS --qualifier ${CDK_BOOTSTRAP_QUALIFIER}"
fi

export AWS_ACCOUNT_SOURCE=${SOFTCOMWEB_INFRA_ACCOUNT_ID}
export AWS_ACCOUNT_CURRENT=`aws sts get-caller-identity --query 'Account' --output text`
export AWS_BOOTSTRAP_REGIONS="eu-central-1 eu-west-1"
export AWS_BOOTSTRAP_CLOUDFORMATION_EXECUTION_POLICY="${AWS_BOOTSTRAP_CLOUDFORMATION_EXECUTION_POLICY:-arn:aws:iam::aws:policy/AdministratorAccess}"
AWS_BOOTSTRAP_ENVIRONMENTS=""

for region in $AWS_BOOTSTRAP_REGIONS; do
  AWS_BOOTSTRAP_ENVIRONMENTS="$AWS_BOOTSTRAP_ENVIRONMENTS aws://${AWS_ACCOUNT_CURRENT}/${region}"
done

if [ "$AWS_ACCOUNT_CURRENT" = "$AWS_ACCOUNT_SOURCE" ]; then
  echo "[INFO] bootstrapping the source account (INFRASTRUCTURE ACCOUNT) with ID: ${AWS_ACCOUNT_CURRENT}"

  npx cdk@${CDK_CLI_VERSION} bootstrap \
    --toolkit-stack-name ${CDK_BOOTSTRAP_STACK} \
    --cloudformation-execution-policies ${AWS_BOOTSTRAP_CLOUDFORMATION_EXECUTION_POLICY} \
    --template ${CDK_BOOTSTRAP_TEMPLATE} \
    ${CDK_BOOTSTRAP_ADDITIONAL_OPTS} ${AWS_BOOTSTRAP_ENVIRONMENTS}
else
  echo "[INFO] bootstrapping a target account ${AWS_ACCOUNT_CURRENT}"
  echo "[INFO] configuring trust for accounts [${AWS_ACCOUNT_SOURCE}]"

  npx cdk@${CDK_CLI_VERSION} bootstrap \
    --toolkit-stack-name ${CDK_BOOTSTRAP_STACK} \
    --trust $AWS_ACCOUNT_SOURCE \
    --cloudformation-execution-policies ${AWS_BOOTSTRAP_CLOUDFORMATION_EXECUTION_POLICY} \
    --template ${CDK_BOOTSTRAP_TEMPLATE} \
    ${CDK_BOOTSTRAP_ADDITIONAL_OPTS} ${AWS_BOOTSTRAP_ENVIRONMENTS}
fi
